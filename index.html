<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cards</title>
    <link rel="stylesheet" href="styles.css">
    <script src="jquery-1.11.1.min.js"></script>
</head>
<body>
<div id="origin"></div>
<div id="info" style="font-size: 32px"></div>
</body>

<script>   // TODO: Add PHPdoc, on window resize origin, krásný odlesky, -webkit- (safari), encapsulate whole script, nejsou některý třídy stejný?, click events could be simplified to .card
    const cards = document.getElementsByClassName('card');
    const cardDimensions = {x: 0, y: 0};
    const cardsContents = ['Lorem ipsum dolor sit amet', 'Lorem ipsum dolor sit amet', 'Lorem ipsum dolor sit amet', 'Lorem ipsum dolor sit amet', 'Lorem ipsum dolor sit amet'];
    const $i = $($('#info'));

    get = (id) => {
        return document.getElementById(id);
    }

    rndSign = () => {
        let r = Math.random();
        return r < .5 ? -1 : 1;
    }

    updateCardDimensions = () => {
        cardDimensions.x = get('card_0').scrollWidth;
        cardDimensions.y = get('card_0').scrollHeight;
    }

    // Extend HTMLElement class to simplify DOM manipulation
    HTMLElement.prototype.addClass = function(className) {
        this.classList.add(className);
    };
    HTMLElement.prototype.removeClass = function(className) {
        this.classList.remove(className);
    };

    get('origin').style.left = window.innerWidth / 5 + 'px';
    get('origin').style.top = window.innerHeight / 5 + 'px';
    function openCard(e) {
        let i = e.target.id.split('_')[1];
        // unsetClickListeners(i);

        /* All of these must be called in particular order */

        // Set initial transformations before rotation
        get(`cardFront_${i}`).removeClass('rotateFrontSide');
        get(`cardFront_${i}`).removeClass('setRotated180');
        get(`cardFront_${i}`).removeClass('rotateFrontToBack');
        get(`cardBack_${i}`).removeClass('rotateBackSide');
        get(`cardBack_${i}`).removeClass('setRotated360');
        get(`cardBack_${i}`).removeClass('rotateBackToFront');
        get(`cardShadow_${i}`).removeClass('rotateShadow');
        get(`cardShadow_${i}`).removeClass('rotateShadowBack');
        get(`cardShadow_${i}`).removeClass('setRotated180');

        // Rotate
        get(`cardFront_${i}`).addClass('rotateFrontSide');
        get(`cardBack_${i}`).addClass('rotateBackSide');
        get(`cardShadow_${i}`).addClass('rotateShadow');
    }

    function closeCard(e) {
        let i = e.target.id.split('_')[1];
        // unsetClickListeners(i);

        /* All of these must be called in particular order */

        // Set initial transformations before rotation
        get(`cardBack_${i}`).addClass('setRotated360');
        get(`cardBack_${i}`).addClass('rotateBackToFront');
        get(`cardShadow_${i}`).addClass('setRotated180');

        // Rotate
        get(`cardFront_${i}`).addClass('setRotated180');
        get(`cardFront_${i}`).addClass('rotateFrontToBack');
        get(`cardShadow_${i}`).addClass('rotateShadowBack');
    }

    // function animate() {
    //     requestAnimationFrame(animate);
        // $i.text($('#card_1').css('animationPlayState'));
        // $i.text($('#cardBack_1').attr('class'));
    // }
    // animate();

    setClickListeners = (i) => {
        get(`cardFront_${i}`).addEventListener(`click`, openCard);
        get(`cardBack_${i}`).addEventListener(`click`, closeCard);
    }

    unsetClickListeners = (i) => {
        get(`cardFront_${i}`).removeEventListener(`click`, openCard);
        get(`cardBack_${i}`).removeEventListener(`click`, closeCard);
    }

    // Generate cards
    const angleSegment = 2 * Math.PI / 5;
    for (let i = 0; i < 5; ++i) {
        const cardHTML =
            `<div class="card" id="card_${i}">` +
            `    <div class="cardFront" id="cardFront_${i}" style="z-index: ${2*i+1}">${cardsContents[i]}</div>` +
            `    <div class="cardBack" id="cardBack_${i}" style="z-index: ${2*i+1}"></div>` +
            `    <div class="cardShadow" id="cardShadow_${i}" style="z-index: ${2*i}"></div>` +
            `</div>`;

        const newCard = document.createElement('template');
        newCard.innerHTML = cardHTML;
        get('origin').appendChild(newCard.content.firstChild);

        if (i === 0)
            updateCardDimensions();

        let angle = angleSegment * i;
        let x = Math.cos(angle) * 20 + cardDimensions.x / 2 + rndSign() * 4 * Math.random();
        let y = Math.sin(angle) * 10 + cardDimensions.y / 2 + rndSign() * 4 * Math.random();
        // const x = rndSign() * 20 * Math.random() - cardDimensions.x / 2 + 'px';
        // const y = rndSign() * 20 * Math.random() - cardDimensions.y / 2 + 'px';
        const newCardEl = get(`card_${i}`);
        newCardEl.style.left = x + 'px';
        newCardEl.style.top = y + 'px';

        setClickListeners(i);

        get(`cardFront_${i}`).addEventListener('webkitAnimationEnd', () => {
            setClickListeners(i);
        });


    }



</script>

</html>