<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cards</title>
    <link rel="stylesheet" href="styles.css?3">
    <script src="jquery-1.11.1.min.js"></script>
</head>
<body>
<div id="origin"></div>
<div id="info" style="font-size: 32px"></div>
</body>

<script>   // TODO: Add PHPdoc, on window resize origin, krásný odlesky, -webkit- (safari), encapsulate whole script, nejsou některý třídy stejný?, click events could be simplified to .card, switch theme feature
    let cards;  // list of all cards elements
    const CLOSED       =  'This is',
          OPEN         =  'the best',
          OPENING      =  'solution',
          CLOSING      =  'of the task',
          TO_BE_CLOSED =  'hire me :)';
    const states = [,,,,,].fill(CLOSED);  // Holds the actual state of each card
    const cardDimensions = {x: 0, y: 0};
    const cardsContents = ['Lorem ipsum dolor sit amet... Lorem ipsum dolor sit amet... Lorem ipsum dolor sit amet... Lorem ipsum dolor sit amet... Lorem ipsum dolor sit amet... Lorem ipsum dolor sit amet... Lorem ipsum dolor sit amet... Lorem ipsum dolor sit amet... Lorem ipsum dolor sit amet... ', 'Lorem ipsum dolor sit amet', 'Lorem ipsum dolor sit amet', 'Lorem ipsum dolor sit amet', 'Lorem ipsum dolor sit amet... Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet... Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet... Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet... Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet...'];
    const $i = $($('#info'));
$i.css('font-size', '40px').css('color', 'gold').css('font-weight', 'bold');
window.location.hash = Date.now();  // clear cache

    /***  Global functions  ***/

    get = (id) => {
        return document.getElementById(id);
    }

    rndSign = () => {
        return Math.random() < .5 ? -1 : 1;
    }

    updateCardDimensions = () => {
        cardDimensions.x = get('card_0').scrollWidth;
        cardDimensions.y = get('card_0').scrollHeight;
    }

    // Extend HTMLElement class to simplify DOM manipulation
    HTMLElement.prototype.addClass = function(className) {
        this.classList.add(className);
    };
    HTMLElement.prototype.removeClass = function(className) {
        this.classList.remove(className);
    };

    get('origin').style.left = window.innerWidth / 5 + 'px';
    // get('origin').style.top = window.innerHeight / 7 + 'px';
    get('origin').style.top = '30px';


    /***  Cards flipping functions  ***/

    function openCard() {
        let i = event.target.id.split('_')[1];
        if (states[i] !== CLOSED) {
            return;
        }

        states[i] = OPENING;

        /* All of these must be called in particular order */

        // Set initial transformations before rotation
        get(`cardBack_${i}`).removeClass('rotateBackSide');
        get(`cardBack_${i}`).removeClass('setRotated180');
        get(`cardBack_${i}`).removeClass('rotateBackToFront');
        get(`cardFront_${i}`).removeClass('rotateFrontSide');
        get(`cardFront_${i}`).removeClass('setRotated360');
        get(`cardFront_${i}`).removeClass('rotateFrontToBack');
        get(`cardShadow_${i}`).removeClass('rotateShadow');
        get(`cardShadow_${i}`).removeClass('rotateShadowFront');
        get(`cardShadow_${i}`).removeClass('setRotated180');

        // Rotate
        get(`cardBack_${i}`).addClass('rotateBackSide');
        get(`cardFront_${i}`).addClass('rotateFrontSide');
        get(`cardShadow_${i}`).addClass('rotateShadow');

        for (let ii = 0; ii < 5; ++ii) {
            if (ii != i) {
                if (states[ii] === OPEN) {
                    // get(`cardFront_${ii}`).click();
                    console.log('closing other card ' + ii);
                    closeCard(ii);
                }
                else if (states[ii] === OPENING) {
                    states[ii] = TO_BE_CLOSED;
                }
            }
        }
    }

    function closeCard(closeCardId) {
        let i = closeCardId === undefined ? event.target.id.split('_')[1] : closeCardId;

        if (states[i] !== OPEN) {
            return;
        }

        states[i] = CLOSING;

        /* All of these must be called in particular order */

        // Set initial transformations before rotation
        get(`cardFront_${i}`).addClass('setRotated360');
        get(`cardFront_${i}`).addClass('rotateFrontToBack');
        get(`cardShadow_${i}`).addClass('setRotated180');

        // Rotate
        get(`cardBack_${i}`).addClass('setRotated180');
        get(`cardBack_${i}`).addClass('rotateBackToFront');
        get(`cardShadow_${i}`).addClass('rotateShadowFront');
    }

    dealCards = () => {
        get(`card_4`).addClass('deal1st');
        get(`card_3`).addClass('deal2st');
        get(`card_2`).addClass('deal3st');
        get(`card_1`).addClass('deal4st');
        get(`card_0`).addClass('deal5st');
    };


    /***  Generate cards  ***/

    const angleSegment = 2 * Math.PI / 5;
    for (let i = 0; i < 5; ++i) {
        const cardHTML =
            `<div class="card" id="card_${i}">` +
            `    <div class="cardBack" id="cardBack_${i}" style="z-index: ${3 * i + 1}"></div>` +
            `    <div class="cardFront" id="cardFront_${i}" style="z-index: ${3 * i + 1}">` +
            `        <div class="cardOverlay" id="cardOverlay_${i}" style="z-index: ${3 * i + 2}"></div>` +
            `        <div class="cardText" id="cardText_${i}">${cardsContents[i]}</div>` +
            `    </div>` +
            `    <div class="cardShadow" id="cardShadow_${i}" style="z-index: ${3 * i}"></div>` +
            `</div>`;

        const newCard = document.createElement('template');
        newCard.innerHTML = cardHTML;
        get('origin').appendChild(newCard.content.firstChild);

        if (i === 0) {
            updateCardDimensions();
        }

        const newCardEl = get(`card_${i}`);
        const angle = angleSegment * i;
        const x = Math.cos(angle) * 20 + cardDimensions.x / 2 + rndSign() * 4 * Math.random();
        const y = Math.sin(angle) * 10 + cardDimensions.y / 2 + rndSign() * 4 * Math.random();

        newCardEl.style.left = x + 'px';
        newCardEl.style.top = y + 'px';

        /* Set listener for initial cards dealing */
        newCardEl.addEventListener('click', dealCards);

        /* Listeners that need to be set after cards dealing */
        newCardEl.addEventListener('webkitAnimationEnd', () => {

            /* Set flip card event listeners */
            get(`cardBack_${i}`).addEventListener(`click`, openCard);

            get(`cardBack_${i}`).addEventListener('webkitAnimationEnd', () => {
                if (states[i] === TO_BE_CLOSED) {
                    states[i] = OPEN;
                    get(`cardFront_${i}`).click();
                }
                else if (states[i] === OPENING) {
                    states[i] = OPEN;
                }
                else if (states[i] === CLOSING) {
                    states[i] = CLOSED;
                }

                /* Set scrolling event listeners */
                setScrollingListeners(i);
            });
        });
    }

    cards = document.getElementsByClassName('card');


    /***  Cards scrolling  ***/

    // TODO: Dvojklikem se dá označit text, nefunguje potom scrolling
    // TODO: Když se dvojklikem otočí karta, nejde scrollovat
    // TODO: grab cursor
    // TODO: fix mobile
    // TODO: Show gradient only when it's possible to scroll
    // TODO: Kinetic scrolling

    let originEventSet;
    let clicked = false;
    let scrolling = false;
    let lastY;

    function setScrollingListeners(i) {
        if (states[i] !== OPEN) return;
        const cardOverlay = get(`cardOverlay_${i}`);
        // const $cardFront = $(`cardFront_${i}`);
        const cardText = get(`cardText_${i}`);

        cardOverlay.addEventListener('touchstart', () => {console.log('touch start')}, false);
        cardOverlay.addEventListener('touchend', () => {console.log('touch end')}, false);

        cardOverlay.addEventListener('mousedown', () => {
            if (event.button === 2) {  // TODO: Make it better when mobile works
                return;
            }
            lastY = event.clientY;
            clicked = true;
            scrolling = false;

            get('origin').addEventListener('select', () => $i.text('select'));  // TODO: Remove
        });

        if (!originEventSet) {
            // $i.text('up');
            get('origin').addEventListener('mouseup', () => {  // TODO: To by chtělo nastavit jen jednou
                console.log('up');
                if (event.button === 2) {  // TODO: Make it better when mobile works
                    return;
                }
                if (!scrolling) {
                    closeCard();
                }
                clicked = false;
                scrolling = false;
                originEventSet = true;
            });
        }

        cardOverlay.addEventListener('mousemove', () => {
            // $i.text('move');
            if (!clicked) return;
            if (!scrolling) {
                scrolling = true;
            }
            let cursorY = event.clientY;
            // let scrollTop = cardText.scrollTop();
            let delta = lastY - cursorY;
            lastY = cursorY;
// $.text(delta);
//             cardText.scrollTop(scrollTop + delta);
            cardText.scrollBy(0, delta);
        });

        // This solves a situation, when a user tries to drag a card to a side
        // (I.e. moves the mouse just horizontally and the browser starts element dragging)
        // $cardFront.on('drag', () => clicked = false);

        // cardOverlay.on('select', () => console.log('select'));
    }
</script>

</html>