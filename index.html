<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cards</title>
    <link rel="stylesheet" href="styles.css">
    <script src="jquery-1.11.1.min.js"></script>
</head>
<body>
<div id="origin"></div>
<div id="info" style="font-size: 32px"></div>
</body>

<script>   // TODO: Add PHPdoc, on window resize origin, krásný odlesky, -webkit- (safari), encapsulate whole script, nejsou některý třídy stejný?, click events could be simplified to .card, change front & back =:-o
    let cards;  // list of all cards elements
    const CLOSED       =  'This is',
          OPEN         =  'the best',
          OPENING      =  'solution',
          CLOSING      =  'of the task',
          TO_BE_CLOSED =  'hire me :)';
    const states = [,,,,,].fill(CLOSED);  // Holds the actual state of each card
    const cardDimensions = {x: 0, y: 0};
    const cardsContents = ['Lorem ipsum dolor sit amet', 'Lorem ipsum dolor sit amet', 'Lorem ipsum dolor sit amet', 'Lorem ipsum dolor sit amet', 'Lorem ipsum dolor sit amet'];
    const $i = $($('#info'));

    get = (id) => {
        return document.getElementById(id);
    }

    rndSign = () => {
        let r = Math.random();
        return r < .5 ? -1 : 1;
    }

    updateCardDimensions = () => {
        cardDimensions.x = get('card_0').scrollWidth;
        cardDimensions.y = get('card_0').scrollHeight;
    }

    // Extend HTMLElement class to simplify DOM manipulation
    HTMLElement.prototype.addClass = function(className) {
        this.classList.add(className);
    };
    HTMLElement.prototype.removeClass = function(className) {
        this.classList.remove(className);
    };

    get('origin').style.left = window.innerWidth / 5 + 'px';
    // get('origin').style.top = window.innerHeight / 7 + 'px';
    get('origin').style.top = '30px';

    function openCard(e) {
        let i = e.target.id.split('_')[1];
        if (states[i] !== CLOSED)
            return;

        states[i] = OPENING;
        // unsetFlipListeners(i);

        /* All of these must be called in particular order */

        // Set initial transformations before rotation
        get(`cardBack_${i}`).removeClass('rotateBackSide');
        get(`cardBack_${i}`).removeClass('setRotated180');
        get(`cardBack_${i}`).removeClass('rotateBackToFront');
        get(`cardFront_${i}`).removeClass('rotateFrontSide');
        get(`cardFront_${i}`).removeClass('setRotated360');
        get(`cardFront_${i}`).removeClass('rotateFrontToBack');
        get(`cardShadow_${i}`).removeClass('rotateShadow');
        get(`cardShadow_${i}`).removeClass('rotateShadowFront');
        get(`cardShadow_${i}`).removeClass('setRotated180');

        // Rotate
        get(`cardBack_${i}`).addClass('rotateBackSide');
        get(`cardFront_${i}`).addClass('rotateFrontSide');
        get(`cardShadow_${i}`).addClass('rotateShadow');

        // vzít všechny ostatní, zavolat na ně closeCard
        for (let ii = 0; ii < 5; ++ii) {
            if (ii != i) {
                if (states[ii] === OPEN) {
                    get(`cardFront_${ii}`).click();
                }
                else if (states[ii] === OPENING) {
                    states[ii] = TO_BE_CLOSED;
                }
            }
        }
    }

    function closeCard(e) {
        let i = e.target.id.split('_')[1];
        if (states[i] !== OPEN)
            return;

        states[i] = CLOSING;
        // unsetFlipListeners(i);

        /* All of these must be called in particular order */

        // Set initial transformations before rotation
        get(`cardFront_${i}`).addClass('setRotated360');
        get(`cardFront_${i}`).addClass('rotateFrontToBack');
        get(`cardShadow_${i}`).addClass('setRotated180');

        // Rotate
        get(`cardBack_${i}`).addClass('setRotated180');
        get(`cardBack_${i}`).addClass('rotateBackToFront');
        get(`cardShadow_${i}`).addClass('rotateShadowFront');
    }

    setFlipListeners = (i) => {
        get(`cardBack_${i}`).addEventListener(`click`, openCard);
        get(`cardFront_${i}`).addEventListener(`click`, closeCard);
    }

    // unsetFlipListeners = (i) => {
    //     get(`cardFront_${i}`).removeEventListener(`click`, openCard);
    //     get(`cardBack_${i}`).removeEventListener(`click`, closeCard);
    // }

    dealCards = () => {
        get(`card_4`).addClass('deal1st');
        get(`card_3`).addClass('deal2st');
        get(`card_2`).addClass('deal3st');
        get(`card_1`).addClass('deal4st');
        get(`card_0`).addClass('deal5st');

        // for (let card of document.getElementsByClassName('card')) {
        //     card.removeEventListener('click', dealCards);
        // }
    };

    // Generate cards
    const angleSegment = 2 * Math.PI / 5;
    for (let i = 0; i < 5; ++i) {
        const cardHTML =
            `<div class="card" id="card_${i}">` +
            `    <div class="cardBack" id="cardBack_${i}" style="z-index: ${2*i+1}"></div>` +
            `    <div class="cardFront" id="cardFront_${i}" style="z-index: ${2*i+1}">${cardsContents[i]}</div>` +
            `    <div class="cardShadow" id="cardShadow_${i}" style="z-index: ${2*i}"></div>` +
            `</div>`;

        const newCard = document.createElement('template');
        newCard.innerHTML = cardHTML;
        get('origin').appendChild(newCard.content.firstChild);

        if (i === 0)
            updateCardDimensions();

        const angle = angleSegment * i;
        const x = Math.cos(angle) * 20 + cardDimensions.x / 2 + rndSign() * 4 * Math.random();
        const y = Math.sin(angle) * 10 + cardDimensions.y / 2 + rndSign() * 4 * Math.random();
        const newCardEl = get(`card_${i}`);
        newCardEl.style.left = x + 'px';
        newCardEl.style.top = y + 'px';

        newCardEl.addEventListener('click', dealCards);

        newCardEl.addEventListener('webkitAnimationEnd', () => {
            setFlipListeners(i);

            get(`cardBack_${i}`).addEventListener('webkitAnimationEnd', () => {
                if (states[i] === TO_BE_CLOSED) {
                    states[i] = OPEN;
                    get(`cardFront_${i}`).click();
                }
                else if (states[i] === OPENING)
                    states[i] = OPEN
                else if (states[i] === CLOSING)
                    states[i] = CLOSED
                // setFlipListeners(i);
            });
        });

    }

    cards = document.getElementsByClassName('card');



</script>

</html>